name: "Good Pipeline"
on:  
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy-env:
        description: 'Entorno donde desplegar (DEV o PROD)'
        required: true
        default: 'DEV'
        type: choice
        options:
          - DEV
          - PROD

jobs:  
  build-and-deploy:    
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.deploy-env || 'DEV' }}
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: A Producción
        uses: ./.github/actions/install

      - name: Declarar variables
        run: |
          if [ "${{ github.job_environment.name }}" == "PROD" ]; then
            echo "Usuario: ${{ secrets.DB_USER_PROD }}, Contraseña: ${{ secrets.DB_PASS_PROD }}, Key: ${{ secrets.API_KEY_PROD }}"
          else
            echo "Usuario: ${{ secrets.DB_USER_DEV }}, Contraseña: ${{ secrets.DB_PASS_DEV }}, Key: ${{ secrets.API_KEY_DEV }}"
          fi

      - name: Configuración
        uses: ./.github/actions/config
        with:
          web-dir: '/var/www/myapp'
          packages: 'nginx curl wget'
          enable-firewall: 'false'
          stop-apache: 'true'
          nginx-config-file: '/etc/nginx/sites-available/default'

      - name: Build
        uses: ./.github/actions/build

      - name: Tests
        uses: ./.github/actions/tests
        with:
          version: 3

      - name: Deploy
        run: |
          echo "Desplegando en ${{ github.job_environment.name }}"
          if [ "${{ github.job_environment.name }}" == "PROD" ]; then
            echo "Usuario: ${{ secrets.DB_USER_PROD }}, Contraseña: ${{ secrets.DB_PASS_PROD }}, Key: ${{ secrets.API_KEY_PROD }}"
         
